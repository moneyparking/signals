app.get("/status/:assessment_id", requireAdmin, async (req, res) => {
  if (!R2_ENABLED) {
    return res.status(500).json({ error: "r2_not_configured" });
  }

  const { assessment_id } = req.params;

  const resultKey = `founding-results/${assessment_id}/result.json`;
  const pdfKey = `founding-review/${assessment_id}.pdf`;
  const lockKey = `locks/${assessment_id}.lock`;

  const [resultMeta, pdfMeta, lockMeta] = await Promise.all([
    getObjectMeta(resultKey),
    getObjectMeta(pdfKey),
    getObjectMeta(lockKey),
  ]);

  const hasResult = !!resultMeta;
  const hasPdf = !!pdfMeta;

  let hasActiveLock = false;

  if (lockMeta?.LastModified) {
    const age = Date.now() - new Date(lockMeta.LastModified).getTime();
    hasActiveLock = age < LOCK_TTL_MS;
  }

  let status = "not_found";

  if (hasActiveLock && !hasPdf) {
    status = hasResult ? "rendering" : "accepted";
  } else if (hasResult && hasPdf && !hasActiveLock) {
    status = "completed";
  } else if (hasResult && !hasPdf && !hasActiveLock) {
    status = "failed";
  }

  res.json({
    assessment_id,
    status,
    artifacts: {
      result: hasResult,
      pdf: hasPdf,
      lock: hasActiveLock,
    },
  });
});
